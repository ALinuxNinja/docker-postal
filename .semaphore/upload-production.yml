version: v1.0
name: Docker Image Upload
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
global_job_config:
  secrets:
    - name: DOCKER_HUB_CATDEPLOYED
    - name: DOCKER_HUB_ILOVEYATOO
blocks:
  - name: Upload
    task:
      jobs:
        - name: 'Alpine Upload'
          commands:
            - checkout
            - cd alpine
            - artifact pull workflow postal-alpine-container.tar
            - docker load -i postal-alpine-container.tar
            - echo "$DOCKER_HUB_PASS_CATDEPLOYED" | docker login --username "$DOCKER_HUB_USER_CATDEPLOYED" --password-stdin
            - docker tag catdeployed/postal:alpine catdeployed/postal:latest
            - docker push catdeployed/postal:alpine
            - docker push catdeployed/postal:latest
            - echo "$DOCKER_HUB_PASS_ILOVEYATOO" | docker login --username "$DOCKER_HUB_USER_ILOVEYATOO" --password-stdin
            - docker tag catdeployed/postal:alpine iloveyatoo/postal:latest
            - docker tag catdeployed/postal:alpine iloveyatoo/postal:alpine
            - docker push iloveyatoo/postal:alpine
            - docker push iloveyatoo/postal:latest
            - echo "$QUAY_PASS_ILOVEYATOO" | docker login --username "$QUAY_USER_ILOVEYATOO" --password-stdin quay.io
            - docker tag catdeployed/postal:alpine quay.io/iloveyatoo/postal:alpine
            - docker tag catdeployed/postal:alpine quay.io/iloveyatoo/postal:latest
            - docker push quay.io/iloveyatoo/postal:alpine
            - docker push quay.io/iloveyatoo/postal:latest
            - artifact yank workflow postal-alpine-container.tar
        - name: 'Ubuntu Upload'
          commands:
            - checkout
            - cd ubuntu
            - artifact pull workflow postal-ubuntu-container.tar
            - docker load -i postal-ubuntu-container.tar
            - echo "$DOCKER_HUB_PASS_CATDEPLOYED" | docker login --username "$DOCKER_HUB_USER_CATDEPLOYED" --password-stdin
            - docker push catdeployed/postal:ubuntu
            - echo "$DOCKER_HUB_PASS_ILOVEYATOO" | docker login --username "$DOCKER_HUB_USER_ILOVEYATOO" --password-stdin
            - docker tag catdeployed/postal:ubuntu iloveyatoo/postal:ubuntu
            - docker push iloveyatoo/postal:ubuntu
            - echo "$QUAY_PASS_ILOVEYATOO" | docker login --username "$QUAY_USER_ILOVEYATOO" --password-stdin quay.io
            - docker tag catdeployed/postal:ubuntu quay.io/iloveyatoo/postal:ubuntu
            - docker push quay.io/iloveyatoo/postal:ubuntu
            - artifact yank workflow postal-ubuntu-container.tar