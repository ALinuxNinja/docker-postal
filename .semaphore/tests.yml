version: v1.0
name: Pipeline 2
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Test
    task:
      jobs:
        - name: 'Alpine Test'
          commands:
            - checkout
            - cd alpine
            - artifact pull workflow postal-alpine-container.tar
            - docker load -i postal-alpine-container.tar
            - docker-compose up -d
            - for i in {1..20}; do if [[ $(docker inspect postal | jq '.[].State.Health.Status') == "healthy" ]]; then break; fi; sleep 15; done;
            - artifact yank workflow postal-alpine-container.tar
        - name: 'Ubuntu Test'
          commands:
            - checkout
            - cd ubuntu
            - artifact pull workflow postal-ubuntu-container.tar
            - docker load -i postal-ubuntu-container.tar
            - docker-compose up -d
            - for i in {1..20}; do if [[ $(docker inspect postal | jq '.[].State.Health.Status') == "healthy" ]]; then break; fi; sleep 15; done;
            - artifact yank workflow postal-ubuntu-container.tar
