version: v1.0
name: Pipeline 2
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Test
    task:
      jobs:
        - name: 'Alpine Test'
          commands:
            - checkout
            - cd alpine
            - artifact pull job postal-alpine-container.tar
            - docker load -i postal-alpine-container.tar
            - docker-compose up -d
            - 'for i in {1..20}; do [ $(docker inspect postal | jq ''.[].State.Health.Status'') == "healthy" ] && break || sleep 15; done'
            - artifact yank job job postal-alpine-container.tar
        - name: 'Ubuntu Test'
          commands:
            - checkout
            - cd ubuntu
            - artifact pull job postal-ubuntu-container.tar
            - docker load -i postal-ubuntu-container.tar
            - docker-compose up -d
            - 'for i in {1..20}; do [ $(docker inspect postal | jq ''.[].State.Health.Status'') == "healthy" ] && break || sleep 15; done'
            - artifact yank job job postal-ubuntu-container.tar
